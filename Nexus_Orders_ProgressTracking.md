# Orders Page - Progress Tracking System

## Purpose
Define the role-based task management system, task dependencies, progress calculation, and how completion tracking integrates across all features.

---

## Overview

The Progress Tracking system provides visibility into which production roles need to work on which jobs, in what order, and tracks completion across all jobs simultaneously.

### Key Concepts
1. **Role-Based Lanes**: Each production role has a "lane" showing all tasks assigned to them
2. **Task Dependencies**: Tasks show when they're available based on prerequisites
3. **Auto-Population**: Tasks are automatically generated from part specifications
4. **Unified Progress**: Task completion updates progress across Kanban, dashboard, and reports
5. **Master Object Sync**: All progress data reads from and writes to the Master Order Object

---

## Designer Assignment Strategy

### Phase 1: No Designer Assignment
- **NO assigned_designer field in Phase 1**
- All designers can see and work on all orders
- No explicit assignment functionality
- Production roles stored but not enforced
- Tasks are available to all employees with the appropriate role

### Implementation Details:
```sql
-- Add to employees table (for future use)
ALTER TABLE employees
ADD COLUMN production_roles JSON DEFAULT NULL
COMMENT 'Array of production roles: ["designer", "vinyl_cnc", "painting", "cut_bend", "leds", "packing"]';

-- Example data:
-- {"roles": ["designer"]}
-- {"roles": ["vinyl_cnc", "cut_bend", "painting"]}
-- {"roles": ["designer", "vinyl_cnc", "leds", "packing"]}
```

### Phase 4+ Future Enhancements:
- Add assigned_designer field to orders table
- Add designer assignment dropdown UI
- Enforce role-based task restrictions
- Filter tasks by assigned designer
- Workload balancing across team members
- Notification system for assigned designers

---

## Production Roles

### Role Definitions

```typescript
enum ProductionRole {
  DESIGNER = 'designer',                          // Creates design files, proofs
  VINYL_CNC = 'vinyl_cnc',                        // CNC cutting, vinyl cutting
  CUT_AND_BEND = 'cut_bend',                      // Metal fabrication, bending
  TRIM_FABRICATION = 'trim_fabrication',          // Trim/cap fabrication
  RETURN_FABRICATION = 'return_fabrication',      // Channel letter returns
  RETURN_GLUING = 'return_gluing',                // Gluing returns to faces
  PAINTING = 'painting',                          // All painting operations
  LEDS = 'leds',                                  // LED installation and wiring
  PINS_DTAPE_GLUING = 'pins_dtape_gluing',        // Pins, double-tape, adhesive
  BACKERS = 'backers',                            // Backer fabrication and prep
  PACKING = 'packing',                            // QC, packing, shipping prep
}
```

### Role Characteristics

**NOTE**: These are rough estimates and can vary widely depending on the type of sign.

| Role | Typical Task Count | Concurrency | Dependencies |
|------|-------------------|-------------|--------------|
| Designer | 1 | Sequential | None (usually first) |
| Vinyl/CNC | 2-3 | Parallel | Designer files |
| Cut & Bend | 2 | Parallel | Designer files |
| Trim Fabrication | 1 | Sequential | Cut & Bend |
| Return Fabrication | 1 | Sequential | Designer files |
| Return Gluing | 1 | Sequential | Return Fab + Faces ready |
| Painting | 0-1 | Sequential | Fabrication complete |
| LEDs | 1 | Sequential | Returns glued |
| Pins/DTape/Gluing | 0-1 | Sequential | Vinyl/painting done |
| Backers | 0-1 | Sequential | Designer files |
| Packing | 1 | Sequential | All previous complete |

---

## Task Structure

### Task Properties (from JobStructure.md)

```typescript
interface PartTask {
  id: string;
  partId: string;
  orderId: string;

  role: ProductionRole;
  taskName: string;
  description?: string;

  sequenceOrder: number;              // Order within role
  dependencies: string[];             // Task IDs that must complete first

  status: TaskStatus;
  isAvailable: boolean;               // Dependencies met?

  estimatedDuration?: number;         // Minutes
  actualDuration?: number;
  dueDate?: Date;

  completedBy?: string;
  completedDate?: Date;
  notes?: string;

  isAutogenerated: boolean;
  createdDate: Date;
}

enum TaskStatus {
  PENDING = 'pending',                // Not yet available
  AVAILABLE = 'available',            // Ready to work on
  IN_PROGRESS = 'in_progress',        // Currently being worked
  COMPLETED = 'completed',            // Finished
  BLOCKED = 'blocked',                // Can't proceed (issue/missing info)
}
```

### Task Availability Logic

```javascript
function calculateTaskAvailability(task, order) {
  // No dependencies = available immediately
  if (task.dependencies.length === 0) {
    return true;
  }

  // Check if all dependency tasks are completed
  const allDepsComplete = task.dependencies.every(depId => {
    const depTask = findTaskById(order, depId);
    return depTask && depTask.status === 'completed';
  });

  // Also check Kanban stage
  const stageAllowsProduction = [
    'approved_for_production',
    'in_production',
    'overdue'
  ].includes(order.kanbanStage);

  return allDepsComplete && stageAllowsProduction;
}
```

---

## UI Layout - Role-Based View

**NOTE**: Holding off on detailed UI layouts for now. General direction: swimlanes are good, but want to make each job more compact (not cards that take up a lot of space).

### Primary View: Swimlanes by Role (Conceptual)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PROGRESS TRACKING                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  View: [By Role â–¼] [By Job] [Calendar]      Filter: [Available Only] [ ] â”‚
â”‚  Show: [All Jobs] [My Assigned Only]        Search: âŒ•                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DESIGNER (Jane)    â”‚  â—· 8 tasks  |  âœ“ 3 done  |  âš¡ 5 available          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     â”‚                                                       â”‚
â”‚ AVAILABLE (5)       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚                     â”‚  â”‚ #200431         â”‚  â”‚ #200428         â”‚           â”‚
â”‚                     â”‚  â”‚ ABC Sign Co     â”‚  â”‚ XYZ Corp        â”‚           â”‚
â”‚                     â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚           â”‚
â”‚                     â”‚  â”‚ Create vectors  â”‚  â”‚ Create proof    â”‚           â”‚
â”‚                     â”‚  â”‚ Channel Letters â”‚  â”‚ Flat cut lettersâ”‚           â”‚
â”‚                     â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚           â”‚
â”‚                     â”‚  â”‚ ðŸ“… Due: 3 days  â”‚  â”‚ ðŸ“… Due: 5 days  â”‚           â”‚
â”‚                     â”‚  â”‚ [Start Task]    â”‚  â”‚ [Start Task]    â”‚           â”‚
â”‚                     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                     â”‚                                                       â”‚
â”‚ IN PROGRESS (0)     â”‚  (none)                                               â”‚
â”‚                     â”‚                                                       â”‚
â”‚ PENDING (3)         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚ (Dependencies)      â”‚  â”‚ #200425         â”‚  â† Grayed out, shows deps       â”‚
â”‚                     â”‚  â”‚ Awaiting customer approval                        â”‚
â”‚                     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VINYL/CNC (Shop)   â”‚  â—· 12 tasks  |  âœ“ 8 done  |  âš¡ 4 available         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AVAILABLE (4)       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚ Sort by: [Due Dateâ–¼]â”‚  â”‚ #200420         â”‚  â”‚ #200418         â”‚           â”‚
â”‚                     â”‚  â”‚ Cut vinyl faces â”‚  â”‚ CNC ACM panel   â”‚           â”‚
â”‚                     â”‚  â”‚ Red 3M vinyl    â”‚  â”‚ Black ACM       â”‚           â”‚
â”‚                     â”‚  â”‚ ðŸ“… Due: 1 dayâš ï¸ â”‚  â”‚ ðŸ“… Due: 2 days  â”‚           â”‚
â”‚                     â”‚  â”‚ [Start Task]    â”‚  â”‚ [Start Task]    â”‚           â”‚
â”‚                     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                     â”‚                                                       â”‚
â”‚ IN PROGRESS (1)     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                     â”‚  â”‚ #200415         â”‚  â† Highlighted, timer shown     â”‚
â”‚                     â”‚  â”‚ Started: 45m agoâ”‚                                 â”‚
â”‚                     â”‚  â”‚ [Complete Task] â”‚                                 â”‚
â”‚                     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CUT & BEND         â”‚  â—· 10 tasks  |  âœ“ 5 done  |  âš¡ 3 available         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ...similar layout...                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[More roles below...]
```

### Alternative View: By Job

Shows all tasks for a single job across all roles.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ORDER #200431 - ABC Sign Company                                          â”‚
â”‚  Channel Letters 'OPEN' + ACM Backer  |  Due: Nov 15  |  Progress: 35%    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Part 1: Channel Letters 'OPEN' w/ LEDs
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Role              â”‚ Task                    â”‚ Status      â”‚ Due   â”‚ Actionâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Designer          â”‚ Create vector files     â”‚ âœ“ Completed â”‚ 11/2  â”‚       â”‚
â”‚ Designer          â”‚ Create proof            â”‚ âœ“ Completed â”‚ 11/3  â”‚       â”‚
â”‚ Vinyl/CNC         â”‚ Cut red vinyl faces     â”‚ In Progress â”‚ 11/5  â”‚[Done] â”‚
â”‚ Cut & Bend        â”‚ Fabricate returns       â”‚ Available   â”‚ 11/6  â”‚[Start]â”‚
â”‚ Return Gluing     â”‚ Glue returns to faces   â”‚ Pending     â”‚ 11/7  â”‚ â¸     â”‚
â”‚ LEDs              â”‚ Install LED modules     â”‚ Pending     â”‚ 11/9  â”‚ â¸     â”‚
â”‚ LEDs              â”‚ Test lighting           â”‚ Pending     â”‚ 11/9  â”‚ â¸     â”‚
â”‚ Packing           â”‚ QC and pack             â”‚ Pending     â”‚ 11/14 â”‚ â¸     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Part 2: ACM Backer
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Designer          â”‚ Create cutting template â”‚ âœ“ Completed â”‚ 11/2  â”‚       â”‚
â”‚ Vinyl/CNC         â”‚ CNC cut ACM             â”‚ Available   â”‚ 11/6  â”‚[Start]â”‚
â”‚ Painting          â”‚ Paint edges black       â”‚ Pending     â”‚ 11/8  â”‚ â¸     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Assembly
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pins/DTape/Gluing â”‚ Mount letters to backer â”‚ Pending     â”‚ 11/10 â”‚ â¸     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Overall Progress: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 35% (7/20 tasks complete)
```

---

## Progress Calculation

### Part-Level Progress

```javascript
function calculatePartProgress(part) {
  const totalTasks = part.tasks.length;
  const completedTasks = part.tasks.filter(t => t.status === 'completed').length;

  if (totalTasks === 0) return 100;  // No tasks = consider complete

  return Math.round((completedTasks / totalTasks) * 100);
}
```

### Order-Level Progress

**Current Implementation**: Progress is based on completed tasks.

**Future Enhancement**: Progress will be based on estimated time left per task (not by dollar value).

```javascript
function calculateOrderProgress(order) {
  // Current Method: Simple task count
  const allTasks = order.parts.flatMap(p => p.tasks);
  const totalTasks = allTasks.length;
  const completedTasks = allTasks.filter(t => t.status === 'completed').length;

  return totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
}

// Future Method: Time-based progress (not implemented yet)
function calculateTimeBasedOrderProgress(order) {
  const allTasks = order.parts.flatMap(p => p.tasks);

  const totalEstimatedTime = allTasks.reduce((sum, t) =>
    sum + (t.estimatedDuration || 0), 0);

  const completedTime = allTasks
    .filter(t => t.status === 'completed')
    .reduce((sum, t) => sum + (t.estimatedDuration || 0), 0);

  return totalEstimatedTime > 0
    ? Math.round((completedTime / totalEstimatedTime) * 100)
    : 0;
}
```

### Progress Milestones

**NOTE**: Not needed if we have progress calculations. Section removed.

---

## Task Completion Workflow

**TODO**: Decide if this will be done in frontend or backend. Recommendation: Backend handles all business logic (validation, dependency updates, progress calculations), frontend only handles UI state and API calls.

### Step-by-Step Process

```
1. User clicks [Start Task] or [Complete Task]
   â†“
2. Frontend sends request to backend
   POST /api/orders/{orderId}/tasks/{taskId}/complete
   Body: { userId, notes?, actualDuration? }
   â†“
3. Backend validates:
   - User has permission for this role
   - Task is in available/in_progress state
   - Order is in valid stage
   â†“
4. Update task in database:
   - status = 'completed'
   - completedBy = userId
   - completedDate = now()
   - Save notes/duration if provided
   â†“
5. Trigger dependency recalculation:
   - Find tasks that depend on this task
   - Mark them as available if all deps met
   â†“
6. Recalculate progress:
   - Part progress %
   - Order overall progress %
   â†“
7. Check for stage advancement triggers:
   - All design tasks done? â†’ Suggest move to "Pending Approval"
   - All production tasks done? â†’ Suggest move to "QC & Packing"
   â†“
8. Log timeline event:
   - "Task completed: Cut vinyl faces (by User X)"
   â†“
9. Return updated order object to frontend
   â†“
10. Frontend updates:
    - Progress bars
    - Task cards
    - Kanban stage (if auto-moved)
    - Dashboard priorities (if order position changed)
```

### API Endpoints

```typescript
// Complete a task
POST /api/orders/:orderId/tasks/:taskId/complete
Body: {
  userId: string;
  notes?: string;
  actualDuration?: number;  // minutes
}
Response: {
  success: boolean;
  task: PartTask;
  partProgress: number;
  orderProgress: number;
  newlyAvailableTasks: PartTask[];
}

// Start a task (mark in progress)
POST /api/orders/:orderId/tasks/:taskId/start
Body: { userId: string }
Response: { success: boolean; task: PartTask }

// Mark task as blocked
POST /api/orders/:orderId/tasks/:taskId/block
Body: {
  userId: string;
  reason: string;
  requiresManagerAttention: boolean;
}
Response: { success: boolean; task: PartTask }

// Unblock a task
POST /api/orders/:orderId/tasks/:taskId/unblock
Body: { userId: string; resolution: string }
Response: { success: boolean; task: PartTask }

// Add manual task
POST /api/orders/:orderId/parts/:partId/tasks
Body: {
  role: ProductionRole;
  taskName: string;
  description?: string;
  sequenceOrder: number;
  dependencies?: string[];
}
Response: { success: boolean; task: PartTask }

// Get tasks by role (for role view)
GET /api/tasks/by-role/:role?status=available&limit=50
Response: {
  tasks: PartTask[];
  orders: Map<orderId, OrderSummary>;  // For displaying order context
}
```

---

## Task Generation

### Phase 1: Template-Based Auto-Generation

Tasks are auto-generated from hard-coded product type templates when order is created:

```javascript
// TEMPORARY IMPLEMENTATION - Phase 1
// Templates hard-coded, will migrate to database in Phase 3

const taskTemplates = {
  'channel_letters_front_lit': [
    { role: 'designer', task: 'Create production files', hours_estimate: 2 },
    { role: 'vinyl_cnc', task: 'Cut vinyl and apply to faces', hours_estimate: 3 },
    { role: 'cut_bend', task: 'Cut and bend returns', hours_estimate: 4 },
    { role: 'painting', task: 'Paint returns', hours_estimate: 2 },
    { role: 'leds', task: 'Install LED modules', hours_estimate: 3 },
    { role: 'packing', task: 'QC and pack for shipping', hours_estimate: 1 }
  ]
  // ... more templates
};
```

- Manager can edit/add/remove tasks after auto-generation
- Future: Auto-augment based on order specifications

---

## Task Auto-Generation

### Template-Based Generation

When an order is created or a part is added, tasks are auto-generated based on product type and specifications.

```javascript
async function generateTasksForPart(part, order) {
  const template = getProductTemplate(part.specifications.productType);
  const generatedTasks = [];

  // Evaluate each rule in template
  for (const rule of template.taskRules) {
    if (rule.condition(part.specifications)) {
      // Add tasks from this rule
      for (const templateTask of rule.tasks) {
        const task = {
          id: generateId(),
          partId: part.id,
          orderId: order.id,
          role: templateTask.role,
          taskName: templateTask.taskName,
          description: templateTask.description,
          sequenceOrder: templateTask.sequenceOrder,
          dependencies: resolveDependencies(templateTask.dependencies, generatedTasks),
          status: 'pending',
          isAvailable: false,  // Will be calculated
          isAutogenerated: true,
          createdDate: new Date()
        };

        generatedTasks.push(task);
      }
    }
  }

  // Calculate availability for all tasks
  generatedTasks.forEach(task => {
    task.isAvailable = calculateTaskAvailability(task, order);
    if (task.isAvailable && task.dependencies.length === 0) {
      task.status = 'available';
    }
  });

  return generatedTasks;
}
```

### Example: Channel Letters Template

```javascript
const channelLettersTemplate = {
  productType: 'channel_letters',

  taskRules: [
    // Always required - Design phase
    {
      condition: () => true,
      tasks: [
        {
          id: 'designer_1',
          role: 'designer',
          taskName: 'Create vector files for letters',
          sequenceOrder: 1,
          dependencies: [],
          estimatedDuration: 120  // 2 hours
        },
        {
          id: 'designer_2',
          role: 'designer',
          taskName: 'Create customer proof',
          sequenceOrder: 2,
          dependencies: ['designer_1'],
          estimatedDuration: 30
        }
      ]
    },

    // Vinyl application (conditional)
    {
      condition: (specs) => specs.requiresVinyl === true,
      tasks: [
        {
          id: 'vinyl_1',
          role: 'vinyl_cnc',
          taskName: 'Cut vinyl for letter faces',
          sequenceOrder: 1,
          dependencies: ['designer_1'],
          estimatedDuration: 60
        },
        {
          id: 'pins_1',
          role: 'pins_dtape_gluing',
          taskName: 'Apply vinyl to acrylic faces',
          sequenceOrder: 1,
          dependencies: ['vinyl_1'],
          estimatedDuration: 90
        }
      ]
    },

    // Metal fabrication (always for channel letters)
    {
      condition: () => true,
      tasks: [
        {
          id: 'cutbend_1',
          role: 'cut_bend',
          taskName: 'Cut and bend metal returns',
          sequenceOrder: 1,
          dependencies: ['designer_1'],
          estimatedDuration: 180
        },
        {
          id: 'returnglue_1',
          role: 'return_gluing',
          taskName: 'Glue returns to faces',
          sequenceOrder: 1,
          dependencies: ['cutbend_1', 'pins_1'],  // Wait for returns AND faces
          estimatedDuration: 120
        }
      ]
    },

    // LEDs (conditional)
    {
      condition: (specs) => specs.hasLighting === true,
      tasks: [
        {
          id: 'leds_1',
          role: 'leds',
          taskName: 'Install LED modules in letters',
          sequenceOrder: 1,
          dependencies: ['returnglue_1'],
          estimatedDuration: 90
        },
        {
          id: 'leds_2',
          role: 'leds',
          taskName: 'Wire and test lighting',
          sequenceOrder: 2,
          dependencies: ['leds_1'],
          estimatedDuration: 60
        }
      ]
    },

    // Final packing (always last)
    {
      condition: () => true,
      tasks: [
        {
          id: 'packing_1',
          role: 'packing',
          taskName: 'Final QC and pack letters',
          sequenceOrder: 99,
          dependencies: ['all_previous'],  // Special marker
          estimatedDuration: 45
        }
      ]
    }
  ]
};
```

### Handling Painting

```javascript
// Painting template rule (used across multiple product types)
{
  condition: (specs) => specs.requiresPainting === true,
  tasks: [
    {
      id: 'painting_1',
      role: 'painting',
      taskName: `Paint ${specs.paintColor || 'specified color'}`,
      sequenceOrder: 1,
      dependencies: ['fabrication_complete'],  // After fab, before assembly
      estimatedDuration: 120
    }
  ]
}
```

---

## Dashboard Integration

### Today's Priorities - Task-Based

The landing dashboard shows tasks that need attention **today** or **tomorrow**, organized by priority.

```javascript
function getTodaysPriorities() {
  const today = startOfDay(new Date());
  const tomorrow = addDays(today, 1);
  const nextBusinessDay = getNextBusinessDay(today);

  return {
    urgent: {
      overdueTasks: getTasksWhere({
        dueDate: { lessThan: today },
        status: { in: ['available', 'in_progress'] }
      }),

      dueToday: getTasksWhere({
        dueDate: { equals: today },
        status: { in: ['available', 'in_progress'] }
      })
    },

    today: {
      availableHighPriority: getTasksWhere({
        status: 'available',
        order: { priority: 'high' },
        dueDate: { lessThanOrEqual: addDays(today, 3) }
      }),

      inProgress: getTasksWhere({
        status: 'in_progress'
      })
    },

    tomorrow: {
      dueTomorrow: getTasksWhere({
        dueDate: { equals: nextBusinessDay },
        status: 'available'
      })
    }
  };
}
```

### Progress Alerts

```javascript
function getProgressAlerts() {
  return {
    stalledJobs: getOrdersWhere({
      lastTaskCompletedAt: { olderThan: days(2) },
      kanbanStage: 'in_production'
    }),

    blockedTasks: getTasksWhere({
      status: 'blocked',
      requiresManagerAttention: true
    }),

    missingDesignFiles: getOrdersWhere({
      kanbanStage: { in: ['details_confirmed', 'pending_design_approval'] },
      hasDesignFiles: false,
      createdDate: { olderThan: days(1) }
    })
  };
}
```

---

## User Permissions

### Role-Based Task Permissions

```javascript
function canUserCompleteTask(user, task) {
  // Owners can complete any task
  if (user.role === 'owner') return true;

  // Managers can complete any task
  if (user.role === 'manager') return true;

  // Designers can complete design tasks
  if (user.role === 'designer' && task.role === 'designer') return true;

  // Production staff can complete tasks matching their assigned roles
  if (user.role === 'production_staff') {
    const userRoles = user.assignedProductionRoles || [];  // From employees table
    return userRoles.includes(task.role);
  }

  return false;
}
```

### Employee Production Roles

Extend the `employees` table to include production role assignments:

```sql
ALTER TABLE employees
ADD COLUMN production_roles JSON;  -- Array of ProductionRole enums

-- Example data:
-- User Jane: ["designer"]
-- User Bob: ["vinyl_cnc", "cut_bend", "painting"]
-- User Alice: ["leds", "pins_dtape_gluing", "packing"]
```

---

## Performance Considerations

### Database Queries

```sql
-- Get available tasks for a specific role (optimized)
SELECT
  t.*,
  o.orderNumber,
  o.customerName,
  o.dueDate,
  o.priority,
  p.title as partTitle
FROM order_tasks t
JOIN orders o ON t.orderId = o.id
JOIN order_parts p ON t.partId = p.id
WHERE t.role = ?
  AND t.status = 'available'
  AND o.kanbanStage IN ('production_queue', 'in_production', 'overdue')
ORDER BY o.priority DESC, o.dueDate ASC
LIMIT 50;

-- Index for this query:
CREATE INDEX idx_tasks_role_status ON order_tasks(role, status, orderId);
CREATE INDEX idx_orders_stage_due ON orders(kanbanStage, dueDate, priority);
```

### Caching Strategy

- Cache task counts per role (refresh every 5 min or on task completion)
- Cache "available tasks" list per role (invalidate on any task completion)
- Cache order progress % (calculate once, store in orders table, update on task change)

---

## Future Enhancements

### Time Tracking Integration
- Link task completion to time tracking system
- Calculate actual time vs estimated time
- Use for future duration predictions

### Smart Task Ordering
- Machine learning to predict optimal task sequence
- Consider multiple jobs, resource availability, due dates
- Suggest batch processing opportunities (e.g., "Paint all black items together")

### Mobile Task Completion
- QR codes on work orders
- Scan to mark task complete from shop floor
- Voice notes for task completion notes

---

## Next Steps

1. âœ… Define progress tracking system (this document)
2. Create database indexes for task queries
3. Build React components for role-based view
4. Implement task completion API endpoints
5. Design progress calculation stored procedures
6. Build dashboard integration for priorities

---

**Document Status**: Initial Planning - Complete
**Last Updated**: 2025-10-31
**Dependencies**: Nexus_Orders_JobStructure.md, Nexus_Orders_KanbanBoard.md
